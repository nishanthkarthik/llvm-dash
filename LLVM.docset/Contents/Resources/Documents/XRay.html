
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>XRay Instrumentation &mdash; LLVM 4 documentation</title>
    
    <link rel="stylesheet" href="_static/llvm-theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="LLVM 4 documentation" href="index.html" />
    <link rel="next" title="The PDB File Format" href="PDB/index.html" />
    <link rel="prev" title="Global Instruction Selection" href="GlobalISel.html" />
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
</style>

  </head>
  <body role="document">
<div class="logo">
  <a href="index.html">
    <img src="_static/logo.png"
         alt="LLVM Logo" width="250" height="88"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="PDB/index.html" title="The PDB File Format"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="GlobalISel.html" title="Global Instruction Selection"
             accesskey="P">previous</a> |</li>
  <li><a href="http://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>
 
      </ul>
    </div>


    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="xray-instrumentation">
<h1>XRay Instrumentation<a class="headerlink" href="#xray-instrumentation" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">1 as of 2016-11-08</td>
</tr>
</tbody>
</table>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#xray-in-llvm" id="id2">XRay in LLVM</a></li>
<li><a class="reference internal" href="#using-xray" id="id3">Using XRay</a><ul>
<li><a class="reference internal" href="#instrumenting-your-c-c-objective-c-application" id="id4">Instrumenting your C/C++/Objective-C Application</a></li>
<li><a class="reference internal" href="#llvm-function-attribute" id="id5">LLVM Function Attribute</a></li>
<li><a class="reference internal" href="#xray-runtime-library" id="id6">XRay Runtime Library</a></li>
<li><a class="reference internal" href="#trace-analysis-tools" id="id7">Trace Analysis Tools</a></li>
</ul>
</li>
<li><a class="reference internal" href="#future-work" id="id8">Future Work</a><ul>
<li><a class="reference internal" href="#flight-data-recorder-mode" id="id9">Flight Data Recorder Mode</a></li>
<li><a class="reference internal" href="#trace-analysis" id="id10">Trace Analysis</a></li>
<li><a class="reference internal" href="#more-platforms" id="id11">More Platforms</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>XRay is a function call tracing system which combines compiler-inserted
instrumentation points and a runtime library that can dynamically enable and
disable the instrumentation.</p>
<p>More high level information about XRay can be found in the <a class="reference external" href="http://research.google.com/pubs/pub45287.html">XRay whitepaper</a>.</p>
<p>This document describes how to use XRay as implemented in LLVM.</p>
</div>
<div class="section" id="xray-in-llvm">
<h2><a class="toc-backref" href="#id2">XRay in LLVM</a><a class="headerlink" href="#xray-in-llvm" title="Permalink to this headline">¶</a></h2>
<p>XRay consists of three main parts:</p>
<ul>
<li><p class="first">Compiler-inserted instrumentation points.</p>
</li>
<li><p class="first">A runtime library for enabling/disabling tracing at runtime.</p>
</li>
<li><p class="first">A suite of tools for analysing the traces.</p>
<p><strong>NOTE:</strong> As of the time of this writing, XRay is only available for x86_64
and arm7 32-bit (no-thumb) Linux.</p>
</li>
</ul>
<p>The compiler-inserted instrumentation points come in the form of nop-sleds in
the final generated binary, and an ELF section named <code class="docutils literal"><span class="pre">xray_instr_map</span></code> which
contains entries pointing to these instrumentation points. The runtime library
relies on being able to access the entries of the <code class="docutils literal"><span class="pre">xray_instr_map</span></code>, and
overwrite the instrumentation points at runtime.</p>
</div>
<div class="section" id="using-xray">
<h2><a class="toc-backref" href="#id3">Using XRay</a><a class="headerlink" href="#using-xray" title="Permalink to this headline">¶</a></h2>
<p>You can use XRay in a couple of ways:</p>
<ul class="simple">
<li>Instrumenting your C/C++/Objective-C/Objective-C++ application.</li>
<li>Generating LLVM IR with the correct function attributes.</li>
</ul>
<p>The rest of this section covers these main ways and later on how to customise
what XRay does in an XRay-instrumented binary.</p>
<div class="section" id="instrumenting-your-c-c-objective-c-application">
<h3><a class="toc-backref" href="#id4">Instrumenting your C/C++/Objective-C Application</a><a class="headerlink" href="#instrumenting-your-c-c-objective-c-application" title="Permalink to this headline">¶</a></h3>
<p>The easiest way of getting XRay instrumentation for your application is by
enabling the <code class="docutils literal"><span class="pre">-fxray-instrument</span></code> flag in your clang invocation.</p>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre>clang -fxray-instrument ..
</pre></div>
</div>
<p>By default, functions that have at least 200 instructions will get XRay
instrumentation points. You can tweak that number through the
<code class="docutils literal"><span class="pre">-fxray-instruction-threshold=</span></code> flag:</p>
<div class="highlight-python"><div class="highlight"><pre>clang -fxray-instrument -fxray-instruction-threshold=1 ..
</pre></div>
</div>
<p>You can also specifically instrument functions in your binary to either always
or never be instrumented using source-level attributes. You can do it using the
GCC-style attributes or C++11-style attributes.</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">[[</span><span class="n">clang</span><span class="o">::</span><span class="n">xray_always_intrument</span><span class="p">]]</span> <span class="kt">void</span> <span class="n">always_instrumented</span><span class="p">();</span>

<span class="p">[[</span><span class="n">clang</span><span class="o">::</span><span class="n">xray_never_instrument</span><span class="p">]]</span> <span class="kt">void</span> <span class="n">never_instrumented</span><span class="p">();</span>

<span class="kt">void</span> <span class="nf">alt_always_instrumented</span><span class="p">()</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">xray_always_intrument</span><span class="p">));</span>

<span class="kt">void</span> <span class="nf">alt_never_instrumented</span><span class="p">()</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">xray_never_instrument</span><span class="p">));</span>
</pre></div>
</div>
<p>When linking a binary, you can either manually link in the <a class="reference internal" href="#xray-runtime-library">XRay Runtime
Library</a> or use <code class="docutils literal"><span class="pre">clang</span></code> to link it in automatically with the
<code class="docutils literal"><span class="pre">-fxray-instrument</span></code> flag.</p>
</div>
<div class="section" id="llvm-function-attribute">
<h3><a class="toc-backref" href="#id5">LLVM Function Attribute</a><a class="headerlink" href="#llvm-function-attribute" title="Permalink to this headline">¶</a></h3>
<p>If you&#8217;re using LLVM IR directly, you can add the <code class="docutils literal"><span class="pre">function-instrument</span></code>
string attribute to your functions, to get the similar effect that the
C/C++/Objective-C source-level attributes would get:</p>
<div class="highlight-llvm"><div class="highlight"><pre><span class="k">define</span> <span class="k">i32</span> <span class="vg">@always_instrument</span><span class="p">()</span> <span class="k">uwtable</span> <span class="s">&quot;function-instrument&quot;</span><span class="p">=</span><span class="s">&quot;xray-always&quot;</span> <span class="p">{</span>
  <span class="c">; ...</span>
<span class="p">}</span>

<span class="k">define</span> <span class="k">i32</span> <span class="vg">@never_instrument</span><span class="p">()</span> <span class="k">uwtable</span> <span class="s">&quot;function-instrument&quot;</span><span class="p">=</span><span class="s">&quot;xray-never&quot;</span> <span class="p">{</span>
  <span class="c">; ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can also set the <code class="docutils literal"><span class="pre">xray-instruction-threshold</span></code> attribute and provide a
numeric string value for how many instructions should be in the function before
it gets instrumented.</p>
<div class="highlight-llvm"><div class="highlight"><pre><span class="k">define</span> <span class="k">i32</span> <span class="vg">@maybe_instrument</span><span class="p">()</span> <span class="k">uwtable</span> <span class="s">&quot;xray-instruction-threshold&quot;</span><span class="p">=</span><span class="s">&quot;2&quot;</span> <span class="p">{</span>
  <span class="c">; ...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="xray-runtime-library">
<h3><a class="toc-backref" href="#id6">XRay Runtime Library</a><a class="headerlink" href="#xray-runtime-library" title="Permalink to this headline">¶</a></h3>
<p>The XRay Runtime Library is part of the compiler-rt project, which implements
the runtime components that perform the patching and unpatching of inserted
instrumentation points. When you use <code class="docutils literal"><span class="pre">clang</span></code> to link your binaries and the
<code class="docutils literal"><span class="pre">-fxray-instrument</span></code> flag, it will automatically link in the XRay runtime.</p>
<p>The default implementation of the XRay runtime will enable XRay instrumentation
before <code class="docutils literal"><span class="pre">main</span></code> starts, which works for applications that have a short
lifetime. This implementation also records all function entry and exit events
which may result in a lot of records in the resulting trace.</p>
<p>Also by default the filename of the XRay trace is <code class="docutils literal"><span class="pre">xray-log.XXXXXX</span></code> where the
<code class="docutils literal"><span class="pre">XXXXXX</span></code> part is randomly generated.</p>
<p>These options can be controlled through the <code class="docutils literal"><span class="pre">XRAY_OPTIONS</span></code> environment
variable, where we list down the options and their defaults below.</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="23%" />
<col width="20%" />
<col width="32%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Type</th>
<th class="head">Default</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>patch_premain</td>
<td><code class="docutils literal"><span class="pre">bool</span></code></td>
<td><code class="docutils literal"><span class="pre">true</span></code></td>
<td>Whether to patch
instrumentation points
before main.</td>
</tr>
<tr class="row-odd"><td>xray_naive_log</td>
<td><code class="docutils literal"><span class="pre">bool</span></code></td>
<td><code class="docutils literal"><span class="pre">true</span></code></td>
<td>Whether to install
the naive log
implementation.</td>
</tr>
<tr class="row-even"><td>xray_logfile_base</td>
<td><code class="docutils literal"><span class="pre">const</span> <span class="pre">char*</span></code></td>
<td><code class="docutils literal"><span class="pre">xray-log.</span></code></td>
<td>Filename base for the
XRay logfile.</td>
</tr>
</tbody>
</table>
<p>If you choose to not use the default logging implementation that comes with the
XRay runtime and/or control when/how the XRay instrumentation runs, you may use
the XRay APIs directly for doing so. To do this, you&#8217;ll need to include the
<code class="docutils literal"><span class="pre">xray_interface.h</span></code> from the compiler-rt <code class="docutils literal"><span class="pre">xray</span></code> directory. The important API
functions we list below:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">__xray_set_handler(void</span> <span class="pre">(*entry)(int32_t,</span> <span class="pre">XRayEntryType))</span></code>: Install your
own logging handler for when an event is encountered. See
<code class="docutils literal"><span class="pre">xray/xray_interface.h</span></code> for more details.</li>
<li><code class="docutils literal"><span class="pre">__xray_remove_handler()</span></code>: Removes whatever the installed handler is.</li>
<li><code class="docutils literal"><span class="pre">__xray_patch()</span></code>: Patch all the instrumentation points defined in the
binary.</li>
<li><code class="docutils literal"><span class="pre">__xray_unpatch()</span></code>: Unpatch the instrumentation points defined in the
binary.</li>
</ul>
<p>There are some requirements on the logging handler to be installed for the
thread-safety of operations to be performed by the XRay runtime library:</p>
<ul class="simple">
<li>The function should be thread-safe, as multiple threads may be invoking the
function at the same time. If the logging function needs to do
synchronisation, it must do so internally as XRay does not provide any
synchronisation guarantees outside from the atomicity of updates to the
pointer.</li>
<li>The pointer provided to <code class="docutils literal"><span class="pre">__xray_set_handler(...)</span></code> must be live even after
calls to <code class="docutils literal"><span class="pre">__xray_remove_handler()</span></code> and <code class="docutils literal"><span class="pre">__xray_unpatch()</span></code> have succeeded.
XRay cannot guarantee that all threads that have ever gotten a copy of the
pointer will not invoke the function.</li>
</ul>
</div>
<div class="section" id="trace-analysis-tools">
<h3><a class="toc-backref" href="#id7">Trace Analysis Tools</a><a class="headerlink" href="#trace-analysis-tools" title="Permalink to this headline">¶</a></h3>
<p>We currently have the beginnings of a trace analysis tool in LLVM, which can be
found in the <code class="docutils literal"><span class="pre">tools/llvm-xray</span></code> directory. The <code class="docutils literal"><span class="pre">llvm-xray</span></code> tool currently
supports the following subcommands:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">extract</span></code>: Extract the instrumentation map from a binary, and return it as
YAML.</li>
</ul>
</div>
</div>
<div class="section" id="future-work">
<h2><a class="toc-backref" href="#id8">Future Work</a><a class="headerlink" href="#future-work" title="Permalink to this headline">¶</a></h2>
<p>There are a number of ongoing efforts for expanding the toolset building around
the XRay instrumentation system.</p>
<div class="section" id="flight-data-recorder-mode">
<h3><a class="toc-backref" href="#id9">Flight Data Recorder Mode</a><a class="headerlink" href="#flight-data-recorder-mode" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="http://research.google.com/pubs/pub45287.html">XRay whitepaper</a> mentions a mode for when events are kept in memory, and
have the traces be dumped on demand through a triggering API. This work is
currently ongoing.</p>
</div>
<div class="section" id="trace-analysis">
<h3><a class="toc-backref" href="#id10">Trace Analysis</a><a class="headerlink" href="#trace-analysis" title="Permalink to this headline">¶</a></h3>
<p>There are a few more subcommands making its way to the <code class="docutils literal"><span class="pre">llvm-xray</span></code> tool, that
are currently under review:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">convert</span></code>: Turns an XRay trace from one format to another. Currently
supporting conversion from the binary XRay log to YAML.</li>
<li><code class="docutils literal"><span class="pre">account</span></code>: Do function call accounting based on data in the XRay log.</li>
</ul>
<p>We have more subcommands and modes that we&#8217;re thinking of developing, in the
following forms:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">stack</span></code>: Reconstruct the function call stacks in a timeline.</li>
<li><code class="docutils literal"><span class="pre">convert</span></code>: Converting from one version of the XRay log to another (higher)
version, and converting to other trace formats (i.e. Chrome Trace Viewer,
pprof, etc.).</li>
<li><code class="docutils literal"><span class="pre">graph</span></code>: Generate a function call graph with relative timings and distributions.</li>
</ul>
</div>
<div class="section" id="more-platforms">
<h3><a class="toc-backref" href="#id11">More Platforms</a><a class="headerlink" href="#more-platforms" title="Permalink to this headline">¶</a></h3>
<p>Since XRay is only currently available in x86_64 and arm7 32-bit (no-thumb)
running Linux, we&#8217;re looking to supporting more platforms (architectures and
operating systems).</p>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="PDB/index.html" title="The PDB File Format"
             >next</a> |</li>
        <li class="right" >
          <a href="GlobalISel.html" title="Global Instruction Selection"
             >previous</a> |</li>
  <li><a href="http://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>
 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2003-2017, LLVM Project.
      Last updated on 2017-06-10.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.6.
    </div>
  </body>
</html>